<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : SalesVhclCbinRcitDAO_SqlMap.xml
    Description : [DMS] 영수증관리 > 기동차통일영수증관리
    author chibeom.song
    since 2017. 2. 20.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 7. 21.   chibeom.song     최초 생성1
-->
<mapper namespace="chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO">

	<resultMap id="blobMap" type="BlobVO">
    	<result property="data" javaType="[B" column="DATA" jdbcType="BLOB"/>
	</resultMap>

    <!-- 영수증관리 > 기동차통일영수증관리 총 갯수를 조회한다. -->
    <select id="selectSalesVehicleCombineReceiptSearchCnt" parameterType="SalesVhclCbinRcitSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptSearchCnt] */
        SELECT COUNT(*) AS VALUE
            FROM (
                    SELECT
                         A.CAR_ID
                        ,A.VIN_NO
                        ,A.CAR_STAT_CD
                        <!--,A.DLR_CD -->
                        ,A.ORD_DLR_CD AS ORD_DLR_CD  <!-- R19080700284出库店代码  贾明2019-8-8-->
                        ,B.DLR_CD  <!-- R19080700284 上传店代码   贾明2019-8-8-->
                        ,NVL2(B.CAR_ID, NVL(B.CERT_FST,'3'), NULL) AS CERT_FST  <!--R19080700284 1通过，0不通过，2作废  3 待审核  初审 sCertfst   贾明 2019-8-8  -->
                        ,NVL2(B.CAR_ID, NVL(B.CERT_2ND,'3'), NULL) AS CERT_2ND  <!--R19080700284 1通过，0不通过，2作废  3 待审核  次月复核 sCertnd -->
                        ,A.CUST_SALE_DT
                        ,(CASE WHEN A.ORD_DLR_CD = #{sDlrCd} THEN 'A' ELSE 'B' END) AS VIN_TYPE
                        <!--
                        ,(CASE WHEN B.RECEIPT_NO IS NOT NULL AND A.ORD_DLR_CD = #{sDlrCd} THEN 'A'
                               WHEN B.RECEIPT_NO IS NULL AND A.ORD_DLR_CD = #{sDlrCd} THEN 'B'
                               WHEN B.RECEIPT_NO IS NOT NULL AND A.ORD_DLR_CD != #{sDlrCd} THEN 'C' END) AS UPLOAD_STAT
                         -->
                         <!--R19080700284 A店提车，B店上传发票，发票系统返回结果时，DCS将发票信息及验伪结果同时回传给提车店和上传发票店。在提车店A的状态字段显示“他店已上传”。 贾明 2019-8-9 start -->
                         ,(CASE WHEN B.RECEIPT_NO IS NOT NULL AND (SELECT USR_ID FROM CM_0801T WHERE USR_ID = B.REG_USR_ID) = B.REG_USR_ID THEN 'A' <!-- 已上传 -->
                                   WHEN B.RECEIPT_NO IS NULL THEN 'B'   <!-- 未上传 -->
                                   WHEN B.RECEIPT_NO IS NOT NULL AND (SELECT USR_ID FROM CM_0801T WHERE USR_ID = B.REG_USR_ID) IS NULL THEN 'C' <!--他店已上传 -->
                           END) AS UPLOAD_STAT<!--状态 -->
                            <!--R19080700284 A店提车，B店上传发票，发票系统返回结果时，DCS将发票信息及验伪结果同时回传给提车店和上传发票店。在提车店A的状态字段显示“他店已上传”。 贾明 2019-8-9 start -->
                        ,B.ERR_UP_CD
                        ,B.TAXPAYER_ID_CD
                        ,NVL(B.RECEIPT_NO, '') AS RECEIPT_NO
                        ,B.RECEIPT_CUST_NM
                        ,B.RECEIPT_ISS_DT
                        ,B.EVAL_RSLT_CD
                        ,B.REG_DT
                        ,B.TAX_CHK_YN
                        ,B.SSN_CRN_NO
                        ,B.SDLR_CD
                    FROM SA_0121T A
                    <!-- R19111100817 增加申请记录 选择项，查询条件 贾明 2019-11-14  START -->
                    <if test='sAppliRecode != null and sAppliRecode != "" and sAppliRecode == "ALL"'>
                         LEFT OUTER JOIN SA_0501T B
                         ON  A.VIN_NO = B.VIN_NO <!--  A.CAR_ID = B.CAR_ID  更改为 A.VIN_NO = B.VIN_NO  贾明 2020-5-25 -->
                    </if>
                     <if test='sAppliRecode != null and sAppliRecode != "" and sAppliRecode == "LAST"'>
                         LEFT OUTER JOIN (
                       <!-- R20042000502 像 LBE2DAFB9KZ103215，这个车，在DMS里查询最新的，却只能查出来19年的那一条，其实还有两条是20年传的，需要像DMS一样增加一个判断 贾明 2020-6-28 RECEIPT_ISS_DT DESC, -->
                         SELECT ROW_NUMBER() OVER(PARTITION BY VIN_NO ORDER BY  REG_DT DESC) NO,
                               F.*
                              FROM SA_0501T F
                        ) B ON  A.VIN_NO = B.VIN_NO <!--  A.CAR_ID = B.CAR_ID  更改为 A.VIN_NO = B.VIN_NO  贾明 2020-5-25 -->
                          AND B.NO=1
                    </if>
                    <!-- R19111100817 增加申请记录 选择项，查询条件 贾明 2019-11-14  END -->
                   WHERE A.CAR_STAT_CD IN ('50','60','70')
                     AND A.NCAR_DSTIN_CD = 'N'
                  ) X
           WHERE (X.CAR_STAT_CD IN ('70') OR X.RECEIPT_NO IS NOT NULL)
            <if test='sCustSaleStDt != null '>
              AND X.CUST_SALE_DT <![CDATA[>=]]> TRUNC(#{sCustSaleStDt},'DD')
            </if>
            <if test='sCustSaleEdDt != null '>
              AND X.CUST_SALE_DT <![CDATA[<]]> TRUNC(#{sCustSaleEdDt},'DD')+1
            </if>
            <if test='sReceiptStDt != null '>
              AND X.RECEIPT_ISS_DT <![CDATA[>=]]> TRUNC(#{sReceiptStDt},'DD')
            </if>
            <if test='sReceiptEdDt != null '>
              AND X.RECEIPT_ISS_DT <![CDATA[<]]> TRUNC(#{sReceiptEdDt},'DD')+1
            </if>
            <if test='sUploadStDt != null '>
              AND X.REG_DT <![CDATA[>=]]> TRUNC(#{sUploadStDt},'DD')
            </if>
            <if test='sUploadEdDt != null '>
              AND X.REG_DT <![CDATA[<]]> TRUNC(#{sUploadEdDt},'DD')+1
            </if>
            <if test='sVinNo != null and sVinNo != ""'>
                AND X.VIN_NO LIKE '%'||#{sVinNo}||'%'
            </if>
            <if test='sReceiptNo != null and sReceiptNo != ""'>
                AND X.RECEIPT_NO = #{sReceiptNo}
            </if>
            <if test='sVinType != null and sVinType != ""'>
                AND X.VIN_TYPE = #{sVinType}
            </if>
            <if test='sUploadStat != null and sUploadStat != ""'>
                AND X.UPLOAD_STAT = #{sUploadStat}
            </if>
            <!-- 增加查询条件  R19080700284  初审  、上传店代码 、 次月复核、 出库店代码 贾明 2019-8-8 start-->
	        <if test='sCertfst != null and sCertfst != ""'>
	             AND X.CERT_FST  =  #{sCertfst}
	        </if>
	        <if test='sCertnd != null and sCertnd != ""'>
	             AND X.CERT_2ND  =  #{sCertnd}
	        </if>
	        <if test='sDlrCds != null and sDlrCds != ""'>
	             AND X.DLR_CD  =  #{sDlrCds}
	        </if>
	        <if test='sOrdDlrCd != null and sOrdDlrCd != ""'>
	             AND X.ORD_DLR_CD  =  #{sOrdDlrCd}
	        </if>
        <!-- 增加查询条件  R19080700284  初审  、上传店代码 、 次月复核、 出库店代码 贾明 2019-8-8 end-->
    </select>

    <!-- 영수증관리 > 기동차통일영수증관리 정보를 조회한다. -->
    <select id="selectSalesVehicleCombineReceiptSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptSearchData] */
        SELECT 
         
             T2.*
             ,FN_CMM_CD_NM('COM020',T2.CHK_SSN_CRN_NO,#{sLangCd},'N') AS CHK_SSN_CRN_NM   <!--  R19111100817 购买方与客户证件号是否一致 -->
             ,FN_CMM_CD_NM('SAL227',T2.CERT_FST,#{sLangCd},'N') AS CERT_FST_NM    <!--R19111100817初审-->
		    ,FN_CMM_CD_NM('SAL227',T2.CERT_2ND,#{sLangCd},'N') AS CERT_2ND_NM    <!--R19111100817次月复核  -->
		    ,FN_CMM_CD_NM('COM020',T2.TAX_CHK_YN,#{sLangCd},'N') AS TAX_CHK_NM <!--R19111100817 已报税 -->
		    ,CASE WHEN FN_CMM_CD_NM('SAL147',T2.ADDTAX_RECEIPT_YN,#{sLangCd},'N') = NULL THEN '' ELSE FN_CMM_CD_NM('SAL147',T2.ADDTAX_RECEIPT_YN,#{sLangCd},'N') END AS INCREASE_TICKET_YN    <!--R19111100817有无增票-->
          
         FROM (
            SELECT ROWNUM AS RNUM, T1.*
                  ,CASE WHEN CUST_SSN_CRN_NO = SSN_CRN_NO THEN 'Y' ELSE DECODE(RECEIPT_NO, '', '', 'N') END AS CHK_SSN_CRN_NO
                  ,CASE WHEN ADDTAX_RECEIPT_NO IS NOT NULL THEN 'Y' ELSE DECODE(RECEIPT_NO, '', '', 'N') END AS ADDTAX_RECEIPT_YN
                  ,FN_CMM_CD_NM('SAL202',UPLOAD_STAT,#{sLangCd},'N') AS UPLOAD_STAT_NM
              FROM (
                SELECT * FROM (
                       SELECT A.CAR_ID
                            ,A.VIN_NO
                            ,A.CAR_STAT_CD
                            <!--,A.ORD_DLR_CD AS DLR_CD -->
                            ,A.ORD_DLR_CD AS ORD_DLR_CD  <!-- R19080700284出库店代码  贾明2019-8-8-->
                            ,B.DLR_CD  <!-- R19080700284 上传店代码   贾明2019-8-8-->
                         ,(SELECT C.MS_PRC
                              FROM SA_0110T C
                               WHERE C.MODEL_CD = A.MODEL_CD
                                   AND C.OCN_CD = A.OCN_CD
                                   AND END_DT >= TO_CHAR(SYSDATE,'YYYYMMDD')) AS MS_PRC  <!-- 指导价 R19080700284 贾明2019-8-8-->
                             , FN_GET_CARLINE_NM_NC(A.CARLINE_CD) AS CARLINE_NM  <!-- 车种名称 R19080700284贾明2019-8-8-->
                            , FN_GET_MODEL_TP_NM(A.MODEL_CD, A.OCN_CD) AS MODEL_NM <!-- 车款 R19080700284贾明2019-8-8 -->
                            ,A.CUST_SALE_DT
                            ,(CASE WHEN A.ORD_DLR_CD = #{sDlrCd} THEN 'A' ELSE 'B' END) AS VIN_TYPE
                            <!--
                            ,(CASE WHEN B.RECEIPT_NO IS NOT NULL AND A.ORD_DLR_CD = #{sDlrCd} THEN 'A'
                                   WHEN B.RECEIPT_NO IS NULL AND A.ORD_DLR_CD = #{sDlrCd} THEN 'B'
                                   WHEN B.RECEIPT_NO IS NOT NULL AND A.ORD_DLR_CD != #{sDlrCd} THEN 'C' END) AS UPLOAD_STAT
                            -->
                             <!--R19080700284 A店提车，B店上传发票，发票系统返回结果时，DCS将发票信息及验伪结果同时回传给提车店和上传发票店。在提车店A的状态字段显示“他店已上传”。 贾明 2019-8-9 start -->
                         ,(CASE WHEN B.RECEIPT_NO IS NOT NULL AND (SELECT USR_ID FROM CM_0801T WHERE USR_ID = B.REG_USR_ID) = B.REG_USR_ID THEN 'A' <!-- 已上传 -->
                                   WHEN B.RECEIPT_NO IS NULL THEN 'B'   <!-- 未上传 -->
                                   WHEN B.RECEIPT_NO IS NOT NULL AND (SELECT USR_ID FROM CM_0801T WHERE USR_ID = B.REG_USR_ID) IS NULL THEN 'C' <!--他店已上传 -->
                           END) AS UPLOAD_STAT<!--状态 -->
                            <!--R19080700284 A店提车，B店上传发票，发票系统返回结果时，DCS将发票信息及验伪结果同时回传给提车店和上传发票店。在提车店A的状态字段显示“他店已上传”。 贾明 2019-8-9 start -->
                            ,C.CONTRACT_NO
                            ,C.CONTRACT_CUST_NO
                            ,(SELECT CUST_NM FROM CR_0101T WHERE DLR_CD = C.DLR_CD AND CUST_NO = C.CONTRACT_CUST_NO) AS CUST_NM
                            ,(SELECT SSN_CRN_NO FROM CR_0101T WHERE DLR_CD = C.DLR_CD AND CUST_NO = C.CONTRACT_CUST_NO) AS CUST_SSN_CRN_NO
                            ,B.ERR_UP_CD
                            ,FN_CMM_CD_NM('SAL200',B.ERR_UP_CD,#{sLangCd},'N') AS ERR_UP_NM
                            ,B.TAXPAYER_ID_CD
                            ,NVL(B.RECEIPT_NO, '') AS RECEIPT_NO
                            ,B.RECEIPT_CUST_NM
                            ,B.RECEIPT_ISS_DT
                             <!--,NVL2(B.CAR_ID, NVL(B.CERT_FST, '2'), NULL) AS CERT_FST-->
                             <!--,NVL2(B.CAR_ID, NVL(B.CERT_2ND, '2'), NULL) AS CERT_2ND-->
                             <!--,NVL2(B.CAR_ID, NVL(B.CERT_3RD, '2'), NULL) AS CERT_3RD-->
                            ,NVL2(B.CAR_ID, NVL(B.CERT_FST, '3'), NULL) AS CERT_FST  <!--R19080700284 1通过，0不通过，2作废  3 待审核  初审 sCertfst   贾明 2019-8-8  -->
                            ,NVL2(B.CAR_ID, NVL(B.CERT_2ND, '3'), NULL) AS CERT_2ND  <!--R19080700284 1通过，0不通过，2作废  3 待审核  次月复核 sCertnd -->
                            ,B.REG_USR_ID
                            ,B.REG_DT
                            ,B.TAX_CHK_YN
                            ,B.SSN_CRN_NO
                            ,B.SDLR_CD
                            --,(SELECT SDLR_CD FROM SA_0504T WHERE TAXPAYER_ID_CD = B.TAXPAYER_ID_CD AND ROWNUM = 1) AS SDLR_CD
                            --,(SELECT DECODE(COUNT(VIN_NO), 0, 'N', 'Y') FROM SA_0502T C WHERE C.VIN_NO = B.VIN_NO) AS ADDTAX_RECEIPT_YN
                            ,(SELECT WM_CONCAT(C.RECEIPT_NO) FROM SA_0502T C WHERE C.VIN_NO = A.VIN_NO GROUP BY C.VIN_NO) AS ADDTAX_RECEIPT_NO
                            --,(SELECT SDLR_TP FROM SA_0504T WHERE TAXPAYER_ID_CD = B.TAXPAYER_ID_CD AND ROWNUM = 1) AS SDLR_TP
                            --,(SELECT SDLR_NM FROM SA_0504T WHERE TAXPAYER_ID_CD = B.TAXPAYER_ID_CD AND ROWNUM = 1) AS SDLR_NM
                            , B.SDLR_TP
                            , B.SDLR_NM
                            , B.RECEIPT_CD <!-- 82 dms机动车统一发票管理画面，发票号码 后面增加 发票代码  贾明 2020-5-6 -->
                            , B.SUM_AMT    <!--  R19092301299 <机动车统一发票管理>页面（发票管理页卡）的发票号码字段后增加一个价税合计小写字段，即显示车辆的开票价格，下载功能 也要增加 贾明 2019-9-23  此处要 2019-10-16上线 -->
                        FROM SA_0121T A
                        LEFT OUTER JOIN SA_0201T C
	                          ON A.VIN_NO = C.VIN_NO
	                         AND A.ORD_DLR_CD = C.DLR_CD
                        <!-- R19111100817 增加申请记录 选择项，查询条件 贾明 2019-11-14  START -->
                    <if test='sAppliRecode != null and sAppliRecode != "" and sAppliRecode == "ALL"'>
                         LEFT OUTER JOIN SA_0501T B
                         ON A.VIN_NO = B.VIN_NO <!--  A.CAR_ID = B.CAR_ID  更改为 A.VIN_NO = B.VIN_NO  贾明 2020-5-25 -->
                    </if>
                     <if test='sAppliRecode != null and sAppliRecode != "" and sAppliRecode == "LAST"'>
                         LEFT OUTER JOIN (
                         <!-- R20042000502 像 LBE2DAFB9KZ103215，这个车，在DMS里查询最新的，却只能查出来19年的那一条，其实还有两条是20年传的，需要像DMS一样增加一个判断 贾明 2020-6-28 RECEIPT_ISS_DT DESC, -->
                         SELECT ROW_NUMBER() OVER(PARTITION BY VIN_NO ORDER BY REG_DT DESC) NO,
                               F.*
                              FROM SA_0501T F
                        ) B ON A.VIN_NO = B.VIN_NO <!--  A.CAR_ID = B.CAR_ID  更改为 A.VIN_NO = B.VIN_NO  贾明 2020-5-25 -->
                          AND B.NO=1
                    </if>
                    <!-- R19111100817 增加申请记录 选择项，查询条件 贾明 2019-11-14  END -->
                       WHERE A.CAR_STAT_CD IN ('50','60','70')
                         AND A.NCAR_DSTIN_CD = 'N'
                     ) X
                 WHERE (X.CAR_STAT_CD IN ('70') OR X.RECEIPT_NO IS NOT NULL)
                    <if test='sCustSaleStDt != null '>
                      AND X.CUST_SALE_DT <![CDATA[>=]]> TRUNC(#{sCustSaleStDt},'DD')
                    </if>
                    <if test='sCustSaleEdDt != null '>
                      AND X.CUST_SALE_DT <![CDATA[<]]> TRUNC(#{sCustSaleEdDt},'DD')+1
                    </if>
                    <if test='sReceiptStDt != null '>
                      AND X.RECEIPT_ISS_DT <![CDATA[>=]]> TRUNC(#{sReceiptStDt},'DD')
                    </if>
                    <if test='sReceiptEdDt != null '>
                      AND X.RECEIPT_ISS_DT <![CDATA[<]]> TRUNC(#{sReceiptEdDt},'DD')+1
                    </if>
                    <if test='sUploadStDt != null '>
                      AND X.REG_DT <![CDATA[>=]]> TRUNC(#{sUploadStDt},'DD')
                    </if>
                    <if test='sUploadEdDt != null '>
                      AND X.REG_DT <![CDATA[<]]> TRUNC(#{sUploadEdDt},'DD')+1
                    </if>
                    <if test='sVinNo != null and sVinNo != ""'>
                        AND X.VIN_NO LIKE '%'||#{sVinNo}||'%'
                    </if>
                    <if test='sReceiptNo != null and sReceiptNo != ""'>
                        AND X.RECEIPT_NO = #{sReceiptNo}
                    </if>
                    <if test='sVinType != null and sVinType != ""'>
                        AND X.VIN_TYPE = #{sVinType}
                    </if>
                    <if test='sUploadStat != null and sUploadStat != ""'>
                        AND X.UPLOAD_STAT = #{sUploadStat}
                    </if>
                    <!-- 增加查询条件  R19080700284  初审  、上传店代码 、 次月复核、 出库店代码 贾明 2019-8-8 start-->
                    <if test='sCertfst != null and sCertfst != ""'>
                        AND X.CERT_FST  =  #{sCertfst}
                    </if>
                    <if test='sCertnd != null and sCertnd != ""'>
                        AND X.CERT_2ND  =  #{sCertnd}
                    </if>
                    <if test='sDlrCds != null and sDlrCds != ""'>
                        AND X.DLR_CD  =  #{sDlrCds}
                    </if>
                    <if test='sOrdDlrCd != null and sOrdDlrCd != ""'>
                        AND X.ORD_DLR_CD  =  #{sOrdDlrCd}
                    </if>
                    <!-- 增加查询条件  R19080700284  初审  、上传店代码 、 次月复核、 出库店代码 贾明 2019-8-8 end-->
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        ) T2
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
            ORDER BY
        <choose>
            <when test='sort != null'>
                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                    <choose>
                        <when test='item.field == "custSaleDt"'>CUST_SALE_DT <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
                        <when test='item.field == "vinNo"'>VIN_NO <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
                        <when test='item.field == "dlrCd"'>DLR_CD <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
                        <when test='item.field == "custNm"'>CUST_NM <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
                        <when test='item.field == "custSsnCrnNo"'>CUST_SSN_CRN_NO <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
                        <when test='item.field == "increaseTicketYn"'>INCREASE_TICKET_YN <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
                    </choose>
                </foreach>
            </when>
            <otherwise>
                RECEIPT_ISS_DT DESC    <!-- R19111100817 增加申请记录 选择项，查询条件 贾明 2019-11-14  -->
            </otherwise>
         </choose>

    </select>

    <!-- 성(우편번호) 목록을  조회한다. -->
    <select id="selectProvinceInfoList" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectProvinceInfoList] */
        SELECT CSTL_CD AS provinceCd, CSTL_NM AS provinceNm FROM CM_2701T
        <where>
            <if test='sProvince != null and sProvince != ""'>
                SUNG_CD = #{sProvince}
            </if>
        </where>
        GROUP BY CSTL_CD, CSTL_NM ORDER BY CSTL_CD
    </select>

    <!-- 영수증관리 > 기동차통일영수증관리 총 갯수를 조회한다. -->
    <select id="selectSaleVehicleCombineReceiptCnt" parameterType="SalesVhclCbinRcitVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSaleVehicleCombineReceiptCnt] */
        SELECT COUNT(*) VALUE
          FROM SA_0501T
         WHERE VIN_NO = #{vinNo}
          <!-- R19080700284  同车架号+同发票号不能重复上传  同车架号+同发票号不能重复上传，同车架号+不同发票号可以重复上传，并且保存上传的履历。但发票系统，只保留最后上传的票据信息 。贾明 2019-8-7   AND TAXPAYER_ID_CD = #{scanPayTaxPinNo} 此处是纳税人识别号  -->
           AND RECEIPT_NO = #{scanRcptNo};
    </select>
    
     <!-- CSR 67 发票提交时对（ 发票代码+发票号码）进行唯一性校验  贾明 2020-3-19 -->
    <select id="selectSaleVehicleCombineReceiptNOCnt" parameterType="SalesVhclCbinRcitVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSaleVehicleCombineReceiptNOCnt] */
        SELECT COUNT(*) VALUE
          FROM SA_0501T
         WHERE RECEIPT_CD = #{scanRcptCd}
           AND RECEIPT_NO = #{scanRcptNo};
    </select>
    
   <!-- R19111100817 发票提交写入SA_0501T 表  贾明 2019-11-11 -->
  <insert id="insertSalesInvoiceInformationSave" parameterType="SalesVhclCbinRcitVO">
  /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesInvoiceInformationSave] */
       INSERT INTO DMSDB.SA_0501T
	        (
	                CAR_ID
                   ,VIN_NO
                   ,VIN_NO1
                   ,VIN_NO2
                   ,DLR_CD
                   ,TAXPAYER_ID_CD
                   ,RECEIPT_NO
                   ,RECEIPT_CD
                   ,RECEIPT_CUST_NM
                   ,SSN_CRN_NO
                   ,RECEIPT_ISS_DT
                   ,SCAN_VIN_NO
                   ,SUM_AMT
                   ,CERT_NO
                   ,ENGN_NO
                   ,SUM_INC_TAX
                   ,SUM_EXC_TAX
                   ,TAX_RT
                   ,TAX_AMT
                   ,MERCH_NM
                   ,ADDR
                   ,SDLR_CD
                   ,TAX_CHK_YN
                   ,REMARK
                   ,TMR_CD
                   ,EVAL_RSLT_CD
                   ,ERR_UP_CD
                   ,ORD_DLR_CD
                   ,TAX_SUNG_CD
                   ,SDLR_TP
                   ,SDLR_NM
                   ,TEL_NO        <!-- crs 37 发票上传扫描信息显示的画面，在 证件号码 后面增加 手机号码 ，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 查找合同客户表的电话 -->
                   ,REG_USR_ID
                   ,REG_DT
                   ,UPDT_USR_ID
                   ,UPDT_DT
	       ) VALUES (
	                 #{carId}
                    ,#{vinNo}
                    ,SUBSTR(#{vinNo}, 1, 11)
                    ,SUBSTR(#{vinNo}, 12, 6)
                    ,#{dlrCd}
                    ,#{scanPayTaxPinNo}
                    ,#{scanRcptNo}
                    ,#{scanRcptCd}
                    ,#{scanCustInfo}
                    ,#{scanSsnCrnNo}
                    ,#{scanRcptPubDt}
                    ,#{scanVinNo}
                    ,#{scanTaxIncPrice}
                    ,#{scanCertNo}
                    ,#{scanEngNo}
                    ,#{scanTaxIncPrice}
                    ,#{scanTaxExcPrice}
                    ,#{scanTaxRate}
                    ,#{scanTaxAmt}
                    ,#{scanSaleCmpnNm}
                    ,#{scanSaleCmpnAddr}
                    ,#{secDlrCd}
                    ,#{taxBeforeChk}
                    ,''
                    ,''
                    ,''
                    ,''
                    ,#{ordDlrCd}
                    ,#{taxSungCd}
                    ,#{sdlrTp}
                    ,#{sdlrNm}
                    ,#{telNo}          <!-- crs 37 发票上传扫描信息显示的画面，在 证件号码 后面增加 手机号码 ，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 查找合同客户表的电话 -->
                    ,#{regUsrId}
                    ,#{regDt}
                    ,#{updtUsrId}
                    ,#{updtDt}
	        )
  
  </insert>
  
   <!--  R19111100817 发票提交写入SA_0501T 表  图片贾明 2019-11-11 -->
    <update id="updateSalesInvoiceInformationImg" parameterType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateSalesInvoiceInformationImg] */
    	UPDATE SA_0501T SET
    		RECEIPT_IMG = #{receiptImg, jdbcType=BLOB}
    	WHERE CAR_ID = #{carId}
    	      AND VIN_NO = #{vinNo}
    	      AND RECEIPT_NO = #{scanRcptNo}
    </update>
    
      <!-- R19111100817 一台车提交了两个不同号的发票，应该显示两行，目前只显示了一行。同时希望可以像<新能源补贴申请审核>页面类似的，可显示全部和最新的数据  修改时，重新发给DCS的信息 贾明 2019-11-11  -->
    <select id="selectSalesInvoiceInformationInfo" parameterType="SalesVhclCbinRcitVO" resultType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesInvoiceInformationInfo] */
        SELECT * FROM SA_0501T
        WHERE VIN_NO = #{vinNo}
              AND CAR_ID = #{carId}
              AND RECEIPT_NO = #{scanRcptNo}
    </select>
    
    <!-- 영수증관리 > 기동차통일영수증관리 정보를 신규 저장한다. -->
    <insert id="insertSalesVehicleCombineReceiptSave" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesVehicleCombineReceiptSave] */
        MERGE INTO SA_0501T A
            USING ( SELECT #{carId} AS CAR_ID
                         , #{vinNo} AS VIN_NO
                         , SUBSTR(#{vinNo}, 1, 11) AS VIN_NO1
                         , SUBSTR(#{vinNo}, 12, 6) AS VIN_NO2
                         , #{dlrCd} AS DLR_CD
                         , #{scanPayTaxPinNo} AS TAXPAYER_ID_CD
                         , #{scanRcptNo} AS RECEIPT_NO
                         , #{scanRcptCd} AS RECEIPT_CD
                         , #{scanCustInfo} AS RECEIPT_CUST_NM
                         , #{scanSsnCrnNo} AS SSN_CRN_NO
                         , #{scanRcptPubDt} AS RECEIPT_ISS_DT
                         , #{scanVinNo} AS SCAN_VIN_NO
                         , #{scanTaxIncPrice} AS SUM_AMT
                         , #{scanCertNo} AS CERT_NO
                         , #{scanEngNo} AS ENGN_NO
                         , #{scanTaxIncPrice} AS SUM_INC_TAX
                         , #{scanTaxExcPrice} AS SUM_EXC_TAX
                         , #{scanTaxRate} AS TAX_RT
                         , #{scanTaxAmt} AS TAX_AMT
                         , #{scanSaleCmpnNm} AS MERCH_NM
                         , #{scanSaleCmpnAddr} AS ADDR
                         , '' AS TMR_CD
                         , '' AS EVAL_RSLT_CD
                         , '' AS ERR_UP_CD
                         , #{secDlrCd} AS SDLR_CD
                         , #{taxBeforeChk} AS TAX_CHK_YN
                         , '' AS REMARK
                         , #{ordDlrCd} AS ORD_DLR_CD
                         , #{taxSungCd} AS TAX_SUNG_CD
                         , #{sdlrTp} AS SDLR_TP
                         , #{sdlrNm} AS SDLR_NM
                         , #{regUsrId} AS REG_USR_ID
                         , #{regDt} AS REG_DT
                         , #{updtUsrId} AS UPDT_USR_ID
                         , #{updtDt} AS UPDT_DT
                      FROM DUAL
                  ) B
            ON ( A.CAR_ID = B.CAR_ID )
        WHEN MATCHED THEN
            UPDATE SET
                  A.DLR_CD          = B.DLR_CD
                 ,A.TAXPAYER_ID_CD  = B.TAXPAYER_ID_CD
                 ,A.RECEIPT_NO      = B.RECEIPT_NO
                 ,A.RECEIPT_CD      = B.RECEIPT_CD
                 ,A.RECEIPT_CUST_NM = B.RECEIPT_CUST_NM
                 ,A.SSN_CRN_NO      = B.SSN_CRN_NO
                 ,A.RECEIPT_ISS_DT  = B.RECEIPT_ISS_DT
                 ,A.SCAN_VIN_NO     = B.SCAN_VIN_NO
                 ,A.SUM_AMT         = B.SUM_AMT
                 ,A.CERT_NO         = B.CERT_NO
                 ,A.ENGN_NO         = B.ENGN_NO
                 ,A.SUM_INC_TAX     = B.SUM_INC_TAX
                 ,A.SUM_EXC_TAX     = B.SUM_EXC_TAX
                 ,A.TAX_RT          = B.TAX_RT
                 ,A.TAX_AMT         = B.TAX_AMT
                 ,A.MERCH_NM        = B.MERCH_NM
                 ,A.ADDR            = B.ADDR
                 ,A.SDLR_CD         = B.SDLR_CD
                 ,A.TAX_CHK_YN      = B.TAX_CHK_YN
                 ,A.REMARK          = B.REMARK
                 ,A.ERR_UP_CD       = B.ERR_UP_CD
                 ,A.ORD_DLR_CD      = B.ORD_DLR_CD
                 ,A.TAX_SUNG_CD     = B.TAX_SUNG_CD
                 ,A.SDLR_TP         = B.SDLR_TP
                 ,A.SDLR_NM         = B.SDLR_NM
                 ,A.UPDT_USR_ID     = B.UPDT_USR_ID
                 ,A.UPDT_DT         = B.UPDT_DT
                 ,A.CERT_FST        = NULL
                 ,A.CERT_2ND        = NULL
                 ,A.CERT_3RD        = NULL
                 ,A.CERT_2RT        = NULL
                 ,A.CERT_3RT        = NULL
        WHEN NOT MATCHED THEN
            INSERT( A.CAR_ID
                   ,A.VIN_NO
                   ,A.VIN_NO1
                   ,A.VIN_NO2
                   ,A.DLR_CD
                   ,A.TAXPAYER_ID_CD
                   ,A.RECEIPT_NO
                   ,A.RECEIPT_CD
                   ,A.RECEIPT_CUST_NM
                   ,A.SSN_CRN_NO
                   ,A.RECEIPT_ISS_DT
                   ,A.SCAN_VIN_NO
                   ,A.SUM_AMT
                   ,A.CERT_NO
                   ,A.ENGN_NO
                   ,A.SUM_INC_TAX
                   ,A.SUM_EXC_TAX
                   ,A.TAX_RT
                   ,A.TAX_AMT
                   ,A.MERCH_NM
                   ,A.ADDR
                   ,A.SDLR_CD
                   ,A.TAX_CHK_YN
                   ,A.REMARK
                   ,A.TMR_CD
                   ,A.EVAL_RSLT_CD
                   ,A.ERR_UP_CD
                   ,A.ORD_DLR_CD
                   ,A.TAX_SUNG_CD
                   ,A.SDLR_TP
                   ,A.SDLR_NM
                   ,A.REG_USR_ID
                   ,A.REG_DT
                   ,A.UPDT_USR_ID
                   ,A.UPDT_DT
            )VALUES( B.CAR_ID
                    ,B.VIN_NO
                    ,B.VIN_NO1
                    ,B.VIN_NO2
                    ,B.DLR_CD
                    ,B.TAXPAYER_ID_CD
                    ,B.RECEIPT_NO
                    ,B.RECEIPT_CD
                    ,B.RECEIPT_CUST_NM
                    ,B.SSN_CRN_NO
                    ,B.RECEIPT_ISS_DT
                    ,B.SCAN_VIN_NO
                    ,B.SUM_AMT
                    ,B.CERT_NO
                    ,B.ENGN_NO
                    ,B.SUM_INC_TAX
                    ,B.SUM_EXC_TAX
                    ,B.TAX_RT
                    ,B.TAX_AMT
                    ,B.MERCH_NM
                    ,B.ADDR
                    ,B.SDLR_CD
                    ,B.TAX_CHK_YN
                    ,B.REMARK
                    ,B.TMR_CD
                    ,B.EVAL_RSLT_CD
                    ,B.ERR_UP_CD
                    ,B.ORD_DLR_CD
                    ,B.TAX_SUNG_CD
                    ,B.SDLR_TP
                    ,B.SDLR_NM
                    ,B.REG_USR_ID
                    ,B.REG_DT
                    ,B.UPDT_USR_ID
                    ,B.UPDT_DT
            )
    </insert>

    <!-- 영수증관리 > 기동차통일영수증관리 이력 정보를 신규 저장한다. -->
    <insert id="insertSalesVehicleCombineReceiptHistSave" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesVehicleCombineReceiptHistSave] */
        INSERT INTO SA_0503T (
             DLR_CD
            ,UP_DT
            ,RECEIPT_NO
            ,RECEIPT_TYPE
            ,VIN_NO
            ,VIN_NO1
            ,VIN_NO2
            ,TAXPAYER_ID_CD
            ,RECEIPT_CD
            ,RECEIPT_CUST_NM
            ,SSN_CRN_NO
            ,RECEIPT_ISS_DT
            ,SCAN_VIN_NO
            ,SUM_AMT
            ,CERT_NO
            ,ENGN_NO
            ,SUM_INC_TAX
            ,SUM_EXC_TAX
            ,TAX_RT
            ,TAX_AMT
            ,MERCH_NM
            ,ADDR
            ,TMR_CD
            ,REG_USR_ID
            ,REG_DT
        ) VALUES (
               #{dlrCd}
             , SYSDATE
             , #{scanRcptNo}
             , 'P'
             , #{scanVinNo}
             , SUBSTR(#{scanVinNo}, 1, 11)
             , SUBSTR(#{scanVinNo}, 12, 6)
             , #{scanPayTaxPinNo}
             , #{scanRcptCd}
             , #{scanCustInfo}
             , #{scanSsnCrnNo}
             , #{scanRcptPubDt}
             , #{scanVinNo}
             , #{scanTaxIncPrice}
             , #{scanCertNo}
             , #{scanEngNo}
             , #{scanTaxIncPrice}
             , #{scanTaxExcPrice}
             , #{scanTaxRate}
             , #{scanTaxAmt}
             , #{scanSaleCmpnNm}
             , #{scanSaleCmpnAddr}
             , ''
             , #{regUsrId}
             , #{regDt}
        );
    </insert>

    <!-- 영수증관리 > 기동차통일영수증관리 정보를 신규 저장한다. -->
    <insert id="insertSalesVehicleCombineReceiptGridSave" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesVehicleCombineReceiptGridSave] */
        INSERT INTO SA_0501T(
                 CAR_ID
                ,VIN_NO
                ,VIN_NO1
                ,VIN_NO2
                ,DLR_CD
                ,ERR_UP_CD
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
        )VALUES(
              #{carId}
            , #{vinNo}
            , SUBSTR(#{vinNo}, 1, 11)
            , SUBSTR(#{vinNo}, 12, 6)
            , #{dlrCd}
            , #{errUpCd}
            , #{regUsrId}
            , SYSDATE
            , #{regUsrId}
            , SYSDATE
        )
    </insert>
    <!-- R19080700284 初审回传结果有审核通过/不通过两种，在界面显示为“通过”或“不通过”。当为“不通过”时，进入发票明细界面可进行修改再提交的操作。 贾明2019-8-12  -->
  <update id="updateVehicleUnifiedInvoiceinfo" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateVehicleUnifiedInvoiceinfo] */
        UPDATE SA_0501T SET
              TAXPAYER_ID_CD = #{scanPayTaxPinNo} <!-- 纳税人识别号 -->
            , CERT_FST = '3'   <!-- 初审 -->
            , RECEIPT_NO  =  #{scanRcptNo} <!-- 发票号码 -->
            , RECEIPT_CD  =  #{scanRcptCd}   <!-- 发票代码 -->
            , RECEIPT_CUST_NM  =  #{scanCustInfo}   <!-- 购买方名称 -->
            , SSN_CRN_NO  =  #{scanSsnCrnNo}   <!-- 证件号码 -->
            , SUM_AMT  =  #{scanTaxIncPrice}   <!-- 价税合计小写-->
            , SUM_INC_TAX  =  #{scanTaxIncPrice}   <!-- 价税合计小写-->
            , SUM_EXC_TAX  =  #{scanTaxExcPrice}   <!-- 不含税价 -->  
            , TAX_AMT  =  #{scanTaxAmt}   <!--税额 -->
            , TAX_RT  =  #{scanTaxRate}   <!-- 税率 -->
            , RECEIPT_ISS_DT  =  #{scanRcptPubDt}   <!--开票日期 -->
            , MERCH_NM  =  #{scanSaleCmpnNm}   <!-- 销货单位名称 -->
            , ADDR  =  #{scanSaleCmpnAddr}   <!-- 联系地址 -->
            , UPDT_USR_ID = #{updtUsrId}
            , UPDT_DT = SYSDATE
            , TEL_NO = #{telNo} <!-- 电话 -->
        WHERE VIN_NO = #{vinNo}
              AND  CAR_ID = #{carId}
              AND RECEIPT_NO = #{scanRcptNo}
  </update>
    <!-- 영수증관리 > 기동차통일영수증관리 정보를 수정한다. -->
    <update id="updateSalesVehicleCombineReceiptGridSave" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateSalesVehicleCombineReceiptGridSave] */
        <!-- UPDATE SA_0501T SET
              ERR_UP_CD = #{errUpCd}
            , UPDT_USR_ID = #{updtUsrId}
            , UPDT_DT = SYSDATE
        WHERE VIN_NO = #{vinNo} -->

        MERGE INTO SA_0501T A
            USING ( SELECT #{carId} AS CAR_ID,
                           #{vinNo} AS VIN_NO,
                           SUBSTR(#{vinNo}, 1, 11) AS VIN_NO1,
                           SUBSTR(#{vinNo}, 12, 6) AS VIN_NO2,
                           #{dlrCd} AS DLR_CD,
                           #{errUpCd} AS ERR_UP_CD,
                           #{updtUsrId} AS REG_USR_ID,
                           SYSDATE AS REG_DT,
                           #{updtUsrId} AS UPDT_USR_ID,
                           SYSDATE AS UPDT_DT
                      FROM DUAL
                  ) B
            ON ( A.CAR_ID = B.CAR_ID )
        WHEN MATCHED THEN
            UPDATE SET
                 A.ERR_UP_CD = B.ERR_UP_CD,
                 A.UPDT_USR_ID = B.UPDT_USR_ID,
                 A.UPDT_DT = B.UPDT_DT
        WHEN NOT MATCHED THEN
            INSERT(A.CAR_ID,
                   A.VIN_NO,
                   A.VIN_NO1,
                   A.VIN_NO2,
                   A.DLR_CD,
                   A.ERR_UP_CD,
                   A.REG_USR_ID,
                   A.REG_DT,
                   A.UPDT_USR_ID,
                   A.UPDT_DT
            )VALUES(B.CAR_ID,
                    B.VIN_NO,
                    B.VIN_NO1,
                    B.VIN_NO2,
                    B.DLR_CD,
                    B.ERR_UP_CD,
                    B.REG_USR_ID,
                    B.REG_DT,
                    B.UPDT_USR_ID,
                    B.UPDT_DT
            )
    </update>

    <!-- 영수증관리 > 기동차통일영수증관리 정보를 조회한다. -->
    <select id="selectSalesVehicleCombineReceiptGridSaveByKey" parameterType="map" resultType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptGridSaveByKey] */
        SELECT * FROM SA_0501T
        WHERE VIN_NO = #{vinNo}
    </select>

<!--  crs 37 发票上传扫描信息显示的画面，在“证件号码”后面增加“手机号码”，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 查找合同客户表的电话 -->
    <select id="selectContractNoSearchTelData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectContractNoSearchTelData] */
    
            SELECT * FROM (
                            SELECT   NVL(TEL_NO1,TEL_NO2) AS TEL_NO
						             ,ROW_NUMBER() OVER(PARTITION BY CONTRACT_NO ORDER BY UPDT_DT DESC) NO  
						        FROM SA_0202T A  
						       WHERE 
						          DLR_CD = #{sDlrCd}
						          <if test='sContractNo != null '>
						              AND A.CONTRACT_NO = #{sContractNo}
						          </if>
						    ) T
						      WHERE NO =1 
    </select>
    

    <!-- 기동차통일영수증관리 > 영수증 업로드 > VIN 총 갯수를 조회한다. -->
    <select id="selectVinNoSearchPopupSearchCnt" parameterType="SalesVhclCbinRcitSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectVinNoSearchPopupSearchCnt] */
        SELECT COUNT(*) AS VALUE
          FROM SA_0121T A
         WHERE A.CAR_STAT_CD IN ('50','60','70')
           AND A.VIN_NO LIKE '%'||#{sVinNo}||'%'
           AND A.NCAR_DSTIN_CD = 'N'
    </select>
    
    <!-- 기동차통일영수증관리 > 영수증 업로드 > VIN 정보를 조회한다. -->
    <select id="selectVinNoSearchPopupSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectVinNoSearchPopupSearchData] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT A.CAR_ID
                      ,A.VIN_NO
                      ,A.ORD_DLR_CD AS DLR_CD
                      ,A.CARLINE_CD
                      ,FN_GET_CARLINE_NM(A.CARLINE_CD) AS CARLINE_NM
                      ,A.MODEL_CD
                      ,FN_GET_MODEL_TP_NM(A.MODEL_CD, A.OCN_CD) AS MODEL_NM
                      ,A.OCN_CD
                      ,FN_GET_OCN_NM(A.MODEL_CD, A.OCN_CD) AS OCN_NM
                      ,A.EXT_COLOR_CD
                      ,FN_GET_EXT_COLOR_NM(A.EXT_COLOR_CD) AS EXT_COLOR_NM
                      ,A.INT_COLOR_CD
                      ,FN_GET_INT_COLOR_NM(A.INT_COLOR_CD) AS INT_COLOR_NM
                      ,A.CAR_STAT_CD
                      ,A.PLT_GI_DT
                      ,A.CUST_SALE_DT
                      ,A.JEONGPAN_NO
                      ,A.VINM_F20010
                      ,B.MS_PRC AS WS_PRC
                      ,A.CONTRACT_NO    <!-- crs 37 发票上传扫描信息显示的画面，在“证件号码”后面增加“手机号码”，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 -->
                  FROM SA_0121T A
                  LEFT OUTER JOIN SA_0110T B
                    ON A.MODEL_CD = B.MODEL_CD
                   AND A.OCN_CD   = B.OCN_CD
                WHERE A.CAR_STAT_CD IN ('50','60','70')
                  AND A.VIN_NO LIKE '%'||#{sVinNo}||'%'
                  AND A.NCAR_DSTIN_CD = 'N'
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 영수증관리 > 2급딜러정보 총 갯수를 조회한다. -->
    <select id="selectSecondDealerSearchCnt" parameterType="SalesVhclCbinRcitSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSecondDealerSearchCnt] */
        SELECT COUNT(*) AS VALUE
          FROM SA_0504T
         WHERE DLR_CD = #{sDlrCd}
           AND TAXPAYER_ID_CD = #{sTaxPayerId}
    </select>

    <!-- 영수증관리 > 2급딜러정보를 조회한다. -->
    <select id="selectSecondDealerSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSecondDealerSearchData] */
        SELECT SDLR_CD
              ,SDLR_TP
              ,DLR_CD
              ,SDLR_NM
          FROM SA_0504T
         WHERE DLR_CD = #{sDlrCd}
           AND TAXPAYER_ID_CD = #{sTaxPayerId}
    </select>

    <!-- 영수증관리 > 영수증 명세를 조회한다. -->
    <select id="selectReceiptDetailPopupSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectReceiptDetailPopupSearchData] */
          SELECT
        	 CAR_ID
            ,VIN_NO
            ,VIN_NO1
            ,VIN_NO2
            ,DLR_CD
            ,TAXPAYER_ID_CD
            ,RECEIPT_NO
            ,RECEIPT_CD
            ,RECEIPT_CUST_NM
            ,SSN_CRN_NO
            ,RECEIPT_ISS_DT
            ,SCAN_VIN_NO
            ,SUM_AMT
            ,CERT_NO
            ,ENGN_NO
            ,SUM_INC_TAX
            ,SUM_EXC_TAX
            ,TAX_RT
            ,TAX_AMT
            ,MERCH_NM
            ,ADDR
            ,TMR_CD
            ,EVAL_RSLT_CD
            ,ERR_UP_CD
            ,REG_USR_ID
            ,REG_DT
            ,UPDT_USR_ID
            ,UPDT_DT
            ,TEL_NO  <!-- crs 37 发票上传扫描信息显示的画面，在“证件号码”后面增加“手机号码”，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 查找合同客户表的电话 -->
     	FROM SA_0501T
        WHERE CAR_ID = #{sCarId} 
        <if test='sReceiptNo != null and sReceiptNo != ""'>
              AND RECEIPT_NO = #{sReceiptNo}   <!-- R19111100817 一台车提交了两个不同号的发票，应该显示两行，目前只显示了一行。同时希望可以像<新能源补贴申请审核>页面类似的，可显示全部和最新的数据 贾明 2019-11-11 查看信息修改数据 -->
       </if>
    </select>
    
     <!-- NO 31 DMS端车辆主信息的发票展示逻辑确定如下：1、车辆对应的发票，只有初审通过状态，没有复核通过的情况，那就以最新审核通过展示；2、有复核通过的发票，那就展示最新复核通过的。 贾明 2019-11-28  -->
    <select id="selectVehicleInfoMotorVehInvo" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectVehicleInfoMotorVehInvo] */
        SELECT * FROM (
			 SELECT 
			       T2.*
			       ,ROW_NUMBER() OVER(PARTITION BY T2.VIN_NO ORDER BY T2.RECEIPT_ISS_DT DESC) NO
			     FROM ( 
			     SELECT * FROM (    
			        SELECT 
			         C.*
			        ,CASE WHEN TO_NUMBER(NVL(C.CERT_FST,0)) <![CDATA[!=]]> 1  THEN 0 ELSE 1  END AS CERT_FSTM
			        ,CASE WHEN TO_NUMBER(NVL(C.CERT_2ND,0)) <![CDATA[!=]]> 1  THEN 0 ELSE 1 END  AS CERT_2NDM
			        FROM SA_0501T C 
			     ) A,
			     (
			        SELECT T1.CAR_ID,MAX(NVL(T1.CERT_FSTS,0) + NVL(T1.CERT_2NDS,0)) CERT_COUNT FROM (
				       SELECT 
				           T.CAR_ID
				           ,CASE WHEN TO_NUMBER(NVL(T.CERT_FST,0))  <![CDATA[!=]]> 1  THEN 0 ELSE 1  END AS  CERT_FSTS
				           ,CASE WHEN TO_NUMBER(NVL(T.CERT_2ND,0))  <![CDATA[!=]]> 1  THEN 0 ELSE 1  END AS  CERT_2NDS
				           FROM SA_0501T T
				          WHERE  1 = 1
				              AND TO_NUMBER(NVL(T.CERT_2ND,0)) <![CDATA[!=]]> 2
				          <if test='sCarId != null and sCarId != ""'>
				              AND T.CAR_ID = #{sCarId}
				          </if>
				     ) T1 
				       GROUP BY T1.CAR_ID
			      ) B
			    WHERE A.CAR_ID = B.CAR_ID 
			      AND (NVL(A.CERT_FSTM,0) + NVL(A.CERT_2NDM,0)) = B.CERT_COUNT
			       <if test='sCarId != null and sCarId != ""'>
				       AND A.CAR_ID = #{sCarId}
				   </if>
			      AND B.CERT_COUNT <![CDATA[>]]>  0
			    ) T2
		 )
			   WHERE  NO = 1
			   ORDER BY RECEIPT_ISS_DT DESC
    </select>

    <select id="selectReceiptImageSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectReceiptImageSearchData] */
        SELECT RECEIPT_IMG
          FROM SA_0501T
         WHERE CAR_ID = #{sCarId}
         <!-- R19111100817 一台车提交了两个不同号的发票，应该显示两行，目前只显示了一行。同时希望可以像<新能源补贴申请审核>页面类似的，可显示全部和最新的数据 贾明 2019-11-11 图片信息 START -->
               AND VIN_NO = #{sVinNo}
               AND   RECEIPT_NO = #{sReceiptNo}
         <!-- R19111100817 一台车提交了两个不同号的发票，应该显示两行，目前只显示了一行。同时希望可以像<新能源补贴申请审核>页面类似的，可显示全部和最新的数据 贾明 2019-11-11 图片信息  END -->
    </select>

    <!-- 영수증관리 > 영수증 이미지를 조회한다.  -->
    <select id="selectSalesVehicleCombineReceiptImg" parameterType="string" resultMap="blobMap">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptImg] */
	   	SELECT RECEIPT_IMG AS DATA
	   	FROM SA_0501T
	   	WHERE CAR_ID = #{value}
    </select>

    <!-- 영수증관리 > 기동차통일영수증 스캔파일을 등록한다. -->
    <update id="updateSalesVehicleCombineReceiptImg" parameterType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateSalesVehicleCombineReceiptImg] */
    	UPDATE SA_0501T SET
    		RECEIPT_IMG = #{receiptImg, jdbcType=BLOB}
    	WHERE CAR_ID = #{carId}
    </update>

    <!-- 영수증관리 > 차량마스터의 보증시작일자 수정구분을 조회한다. -->
    <select id="selectVehicleMasterUpdtCd" parameterType="SalesVhclCbinRcitVO" resultType="String">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectVehicleMasterUpdtCd] */
        SELECT NVL(TEMP4, ' ') AS UPDT_CD
          FROM SA_0121T
         WHERE CAR_ID = #{carId}
    </select>

    <!-- 영수증관리 > 차량마스터의 보증시작일자를 수정한다. -->
    <update id="updateSalesVehicleMasterSave" parameterType="SalesVhclCbinRcitVO">
        UPDATE SA_0121T SET TEMP3 = GRTE_START_DT
                           ,GRTE_START_DT = #{scanRcptPubDt}
                           ,TEMP4 = 'I'
                           ,UPDT_USR_ID = #{updtUsrId}
                           ,UPDT_DT = #{updtDt}
         WHERE CAR_STAT_CD IN ('70')
           AND CAR_ID = #{carId}
    </update>

    <select id="selectDealerSungStr" parameterType="SalesVhclCbinRcitVO" resultType="String">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectDealerSungStr] */
        SELECT SALE_DLR_SUNG_CD
          FROM CM_0101T
         WHERE DLR_CD = #{sDlrCd}
    </select>

    <!-- 영수증관리 > 기동차통일영수증관리 정보를 IS테이블에 신규 저장한다. -->
    <insert id="insertSalesVehicleCombineReceiptSaveIs" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesVehicleCombineReceiptSaveIs] */
        MERGE INTO SA_0501IS A
            USING ( SELECT #{carId} AS CAR_ID
                         , #{vinNo} AS VIN_NO
                         , SUBSTR(#{vinNo}, 1, 11) AS VIN_NO1
                         , SUBSTR(#{vinNo}, 12, 6) AS VIN_NO2
                         , #{dlrCd} AS DLR_CD
                         , #{scanPayTaxPinNo} AS TAXPAYER_ID_CD
                         , #{scanRcptNo} AS RECEIPT_NO
                         , #{scanRcptCd} AS RECEIPT_CD
                         , #{scanCustInfo} AS RECEIPT_CUST_NM
                         , #{scanSsnCrnNo} AS SSN_CRN_NO
                         , #{scanRcptPubDt} AS RECEIPT_ISS_DT
                         , #{scanVinNo} AS SCAN_VIN_NO
                         , #{scanTaxIncPrice} AS SUM_AMT
                         , #{scanCertNo} AS CERT_NO
                         , #{scanEngNo} AS ENGN_NO
                         , #{scanTaxIncPrice} AS SUM_INC_TAX
                         , #{scanTaxExcPrice} AS SUM_EXC_TAX
                         , #{scanTaxRate} AS TAX_RT
                         , #{scanTaxAmt} AS TAX_AMT
                         , #{scanSaleCmpnNm} AS MERCH_NM
                         , #{scanSaleCmpnAddr} AS ADDR
                         , '' AS TMR_CD
                         , '' AS EVAL_RSLT_CD
                         , '' AS ERR_UP_CD
                         , #{secDlrCd} AS SDLR_CD
                         , #{taxBeforeChk} AS TAX_CHK_YN
                         , '' AS REMARK
                         , #{ordDlrCd} AS ORD_DLR_CD
                         , #{taxSungCd} AS TAX_SUNG_CD
                         , #{sdlrTp} AS SDLR_TP
                         , #{sdlrNm} AS SDLR_NM
                         , #{regUsrId} AS REG_USR_ID
                         , #{regDt} AS REG_DT
                         , #{updtUsrId} AS UPDT_USR_ID
                         , #{updtDt} AS UPDT_DT
                      FROM DUAL
                  ) B
            ON ( A.CAR_ID = B.CAR_ID )
        WHEN MATCHED THEN
            UPDATE SET
                  A.DLR_CD          = B.DLR_CD
                 ,A.TAXPAYER_ID_CD  = B.TAXPAYER_ID_CD
                 ,A.RECEIPT_NO      = B.RECEIPT_NO
                 ,A.RECEIPT_CD      = B.RECEIPT_CD
                 ,A.RECEIPT_CUST_NM = B.RECEIPT_CUST_NM
                 ,A.SSN_CRN_NO      = B.SSN_CRN_NO
                 ,A.RECEIPT_ISS_DT  = B.RECEIPT_ISS_DT
                 ,A.SCAN_VIN_NO     = B.SCAN_VIN_NO
                 ,A.SUM_AMT         = B.SUM_AMT
                 ,A.CERT_NO         = B.CERT_NO
                 ,A.ENGN_NO         = B.ENGN_NO
                 ,A.SUM_INC_TAX     = B.SUM_INC_TAX
                 ,A.SUM_EXC_TAX     = B.SUM_EXC_TAX
                 ,A.TAX_RT          = B.TAX_RT
                 ,A.TAX_AMT         = B.TAX_AMT
                 ,A.MERCH_NM        = B.MERCH_NM
                 ,A.ADDR            = B.ADDR
                 ,A.SDLR_CD         = B.SDLR_CD
                 ,A.TAX_CHK_YN      = B.TAX_CHK_YN
                 ,A.REMARK          = B.REMARK
                 ,A.ERR_UP_CD       = B.ERR_UP_CD
                 ,A.ORD_DLR_CD      = B.ORD_DLR_CD
                 ,A.TAX_SUNG_CD     = B.TAX_SUNG_CD
                 ,A.SDLR_TP         = B.SDLR_TP
                 ,A.SDLR_NM         = B.SDLR_NM
                 ,A.UPDT_USR_ID     = B.UPDT_USR_ID
                 ,A.UPDT_DT         = B.UPDT_DT
                 ,A.IFRESULT        = 'N'
        WHEN NOT MATCHED THEN
            INSERT( A.CAR_ID
                   ,A.VIN_NO
                   ,A.VIN_NO1
                   ,A.VIN_NO2
                   ,A.DLR_CD
                   ,A.TAXPAYER_ID_CD
                   ,A.RECEIPT_NO
                   ,A.RECEIPT_CD
                   ,A.RECEIPT_CUST_NM
                   ,A.SSN_CRN_NO
                   ,A.RECEIPT_ISS_DT
                   ,A.SCAN_VIN_NO
                   ,A.SUM_AMT
                   ,A.CERT_NO
                   ,A.ENGN_NO
                   ,A.SUM_INC_TAX
                   ,A.SUM_EXC_TAX
                   ,A.TAX_RT
                   ,A.TAX_AMT
                   ,A.MERCH_NM
                   ,A.ADDR
                   ,A.SDLR_CD
                   ,A.TAX_CHK_YN
                   ,A.REMARK
                   ,A.TMR_CD
                   ,A.EVAL_RSLT_CD
                   ,A.ERR_UP_CD
                   ,A.ORD_DLR_CD
                   ,A.TAX_SUNG_CD
                   ,A.SDLR_TP
                   ,A.SDLR_NM
                   ,A.REG_USR_ID
                   ,A.REG_DT
                   ,A.UPDT_USR_ID
                   ,A.UPDT_DT
                   ,A.IFRESULT
            )VALUES( B.CAR_ID
                    ,B.VIN_NO
                    ,B.VIN_NO1
                    ,B.VIN_NO2
                    ,B.DLR_CD
                    ,B.TAXPAYER_ID_CD
                    ,B.RECEIPT_NO
                    ,B.RECEIPT_CD
                    ,B.RECEIPT_CUST_NM
                    ,B.SSN_CRN_NO
                    ,B.RECEIPT_ISS_DT
                    ,B.SCAN_VIN_NO
                    ,B.SUM_AMT
                    ,B.CERT_NO
                    ,B.ENGN_NO
                    ,B.SUM_INC_TAX
                    ,B.SUM_EXC_TAX
                    ,B.TAX_RT
                    ,B.TAX_AMT
                    ,B.MERCH_NM
                    ,B.ADDR
                    ,B.SDLR_CD
                    ,B.TAX_CHK_YN
                    ,B.REMARK
                    ,B.TMR_CD
                    ,B.EVAL_RSLT_CD
                    ,B.ERR_UP_CD
                    ,B.ORD_DLR_CD
                    ,B.TAX_SUNG_CD
                    ,B.SDLR_TP
                    ,B.SDLR_NM
                    ,B.REG_USR_ID
                    ,B.REG_DT
                    ,B.UPDT_USR_ID
                    ,B.UPDT_DT
                    ,'N'
            )
    </insert>

    <!-- 영수증관리 > 기동차통일영수증 스캔파일을 Is테이블에 등록한다. -->
    <update id="updateSalesVehicleCombineReceiptImgIs" parameterType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateSalesVehicleCombineReceiptImgIs] */
        UPDATE SA_0501IS SET
            RECEIPT_IMG = #{receiptImg, jdbcType=BLOB}
        WHERE CAR_ID = #{carId}
    </update>
</mapper>